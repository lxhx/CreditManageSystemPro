@model CreditManageSystemPro.Admin.Models.AddMenuModel
@{
    ViewBag.Title = "菜单";
}
<link href="@Url.Content("~/Content/bootstrap.min.css?v=3.3.5")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/font-awesome.min.css?v=4.4.0")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/animate.min.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/style.min.css?v=4.0.0")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Content/plugins/jsTree/style.min.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/plugins/chosen/chosen.css")" rel="stylesheet" />
<link href="@Url.Content("~/Scripts/plugins/layer/skin/layer.css")" rel="stylesheet" />
<script src="@Url.Content("~/Scripts/jquery.min.js?v=2.1.4")" type="text/javascript"></script>
<body class="gray-bg">
    <div class="wrapper wrapper-content  animated fadeInRight">
        <input type="hidden" value="0" id="selectedMenuId" />
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>
                            菜单</h5>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <button class="btn btn-primary " type="button" id="add">
                            <i class="fa fa-plus"></i>&nbsp;新增菜单</button>&nbsp;&nbsp;&nbsp;
                        <button class="btn btn-primary " type="button" id="edit">
                            <i class="fa fa-edit"></i>&nbsp;编辑菜单</button>&nbsp;&nbsp;&nbsp;
                        <button class="btn btn-primary " type="button" id="delete">
                            <i class="fa fa-trash"></i>&nbsp;删除菜单</button>
                        <div class="ibox-tools">
                        </div>
                    </div>
                    <div class="ibox-content">
                        <div id="using_json">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="@Url.Content("~/Scripts/bootstrap.min.js?v=3.3.5")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/plugins/chosen/chosen.jquery.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/plugins/layer/layer.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/plugins/jsTree/jstree.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/plugins/validate/jquery.validate.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/plugins/validate/messages_zh.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/demo/form-validate-demo.min.js")" type="text/javascript"></script>
    <script type="text/javascript">
        //将form转为AJAX提交
        function ajaxSubmit(frm, fn) {
            var dataPara = getFormJson(frm);
            $.ajax({
                url: frm.action,
                type: frm.method,
                data: dataPara,
                success: fn
            });
        }

        //将form中的值转换为键值对。
        function getFormJson(frm) {
            var o = {};
            var a = $(frm).serializeArray();
            $.each(a, function () {
                if (o[this.name] !== undefined) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        }

        function showTree() {
            $.ajax({
                type: "post",
                url: "/admin/Menu/Jstree",
                async: false,
                dataType: "text",
                success: function (data) {
                    createTree(data);
                }
            });
        }

        function createTree(datastr) {
            datastr = eval('(' + datastr + ')');
            $('#using_json').jstree({
                'plugins': ["themes", "checkbox", "types"],
                'core': {
                    "animation": 0,
                    "multiple": false,
                    "data": datastr,
                    "check_callback": true
                },
                "types": {
                    "default": {
                        "icon": "fa fa-folder icon-state-warning icon-lg"
                    },
                    "file": {
                        "icon": "fa fa-file icon-state-warning icon-lg"
                    }
                }
            })
            .bind("select_node.jstree", function (event, data) {
                var i, j, menuid = 0;
                for (i = 0, j = data.selected.length; i < j; i++) {
                    menuid = data.instance.get_node(data.selected[i]).id;
                }
                $("#selectedMenuId").val(menuid);
            })
            .bind("deselect_node.jstree", function (event, data) {
                $("#selectedMenuId").val("0");
            })
            .bind("delete_node.jstree", function (event, data) {
                
            });
        }

        //增加菜单事件
        $('#add').on("click", function () {
            layer.open({
                type: 2, //page层
                area: ['60%', '70%'],
                title: '新增菜单',
                shade: 0.2, //遮罩透明度
                shadeClose: false,
                maxmin: true,
                moveType: 1, //拖拽风格，0是默认，1是传统拖动
                shift: 1, //0-6的动画形式，-1不开启
                content: 'Add'
            });
        });

        //编辑菜单事件
        $('#edit').on("click", function () {
            if (parseInt($("#selectedMenuId").val()) == 0) {
                alert("请您选择要编辑的菜单");
            } else {
                layer.open({
                    type: 2, //page层
                    area: ['60%', '70%'],
                    title: '编辑菜单',
                    shade: 0.2, //遮罩透明度
                    shadeClose: false,
                    maxmin: true,
                    moveType: 1, //拖拽风格，0是默认，1是传统拖动
                    shift: 1, //0-6的动画形式，-1不开启
                    content: 'Update'
                });
            }
        });

        $("#delete").on("click", function () {
            if (parseInt($("#selectedMenuId").val()) == 0) {
                alert("请您选择要删除的菜单");
            }
            else {
                if (confirm('此操作将删除所选菜单及其子菜单，确定要删除所选菜单吗?')) {
                    //instance.delete_node([instance.get_node(selectedMenuId)]);
                    $.ajax({
                        type: "post",
                        url: "/admin/Menu/Delete",
                        async: false,
                        data: { id: $("#selectedMenuId").val() },
                        dataType: "text",
                        success: function (data) {
                            var datastr = eval('(' + data + ')');
                            if (datastr.success) {
                                $('#using_json').jstree().destroy();
                                $("#selectedMenuId").val("0");
                                showTree();
                                alert(datastr.msg);
                            } else {
                                alert(datastr.msg);
                            }
                        },
                        error: function (data) {
                            var datastr = eval('(' + data + ')');
                            alert(datastr.msg);
                        }
                    });
                }
            }
        });
        $(document).ready(function () {
            showTree();
            //        $.ajax({
            //            type: "post",
            //            url: "/admin/Menu/Jstree",
            //            async: false,
            //            dataType: "text",
            //            success: function (data) {
            //                $("#using_json").jstree(eval('(' + data + ')'));
            //            }
            //        });
            //$("#using_json").jstree({"core": {"data": [{"text": "首页"},{"text": "个人资料"},{"text": "系统管理","state": {"opened": true},"children": [{"text": "用户管理"},{"text": "角色管理"},{"text": "权限管理"},{"text": "菜单管理"},]},{"text": "信箱"},{"text": "客户管理"},{"text": "贷款管理"},{"text": "审查管理"},]}});
            //$("#using_json").jstree({"core": { "data": [{ "text": "Empty Folder"}, { "text": "Resources", "state": { "opened": true }, "children": [{ "text": "css", "children": [{ "text": "animate.css", "icon": "none" }, { "text": "bootstrap.css", "icon": "none" }, { "text": "main.css", "icon": "none" }, { "text": "style.css", "icon": "none"}], "state": { "opened": true} }, { "text": "js", "children": [{ "text": "bootstrap.js", "icon": "none" }, { "text": "hplus.min.js", "icon": "none" }, { "text": "jquery.min.js", "icon": "none" }, { "text": "jsTree.min.js", "icon": "none" }, { "text": "custom.min.js", "icon": "none"}], "state": { "opened": true} }, { "text": "html", "children": [{ "text": "layout.html", "icon": "none" }, { "text": "navigation.html", "icon": "none" }, { "text": "navbar.html", "icon": "none" }, { "text": "footer.html", "icon": "none" }, { "text": "sidebar.html", "icon": "none"}], "state": { "opened": true}}] }, {"text":"Fonts"}, {"text":"Images"}, {"text":"Scripts"}, {"text":"Templates"}]} });
        });

    </script>
    <script src="@Url.Content("~/Scripts/demo/form-advanced-demo.min.js")" type="text/javascript"></script>
</body>
